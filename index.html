<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Enter Zen - Interactive book experience leading to zen stories and wisdom">
    <title>Enter Zen From There</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/zen-elements.css">
    <link rel="stylesheet" href="css/enhanced-zen.css">
    <link rel="stylesheet" href="css/webgl-zen.css">
    <!-- Preload images for better performance -->
    <link rel="preload" href="assets/book2.png" as="image">
    <!-- <link rel="preload" href="assets/cosmic.png" as="image"> -->
</head>
<body>
    <!-- WebGL Zen Space Container -->
    <div id="zen-space-container"></div>
    
    <!-- Yin-Yang Balance Indicator -->
    <div id="balance-indicator">
      <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <circle cx="50" cy="50" r="40" fill="black" stroke="white" stroke-width="2"/>
        <path d="M50,10 a40,40 0 0,1 0,80 a20,20 0 0,0 0,-40 a20,20 0 0,0 0,-40" fill="white"/>
        <circle cx="50" cy="30" r="5" fill="black"/>
        <circle cx="50" cy="70" r="5" fill="white"/>
      </svg>
    </div>
    
    <!-- Audio Controls -->
    <div id="zen-audio-controls">
      <svg id="audio-on" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
      </svg>
      <svg id="audio-off" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="display:none;">
        <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
      </svg>
    </div>
    
    <!-- Loading Screen -->
    <div id="zen-loading">
      <div class="loader"></div>
      <div class="text">Creating Zen Space...</div>
    </div>
    
    <!-- Chakra Info Template (will be cloned by JS) -->
    <div id="chakra-info-template" class="chakra-info" style="display:none;">
      <h3 id="chakra-name"></h3>
      <p id="chakra-description"></p>
    </div>
    
    <!-- Original cosmic background - hidden but kept for fallback -->
    <div class="cosmic-background" aria-hidden="true" style="display: none;">
        <!-- The stars-container will be added here by JS -->
    </div>
    <main class="container">
        <div class="book-container" tabindex="0" role="button" aria-label="Interactive book. Click to open and enter zen world">
            <div class="book">
                <div class="book-cover">
                    <img src="assets/book2.png" alt="Zen Book Cover showing a path through a serene landscape">
                    <div class="enter-text">Enter Zen</div>
                </div>
                <div class="book-page left-page"></div>
                <div class="book-page right-page"></div>
                <div class="book-spine"></div>
                <div class="page-turning-effect"></div>
            </div>
        </div>
    </main>
    
    <!-- Help message for keyboard users -->
    <div class="accessibility-help" aria-live="polite">
        Press Enter or Space to open the book
    </div>
    
    <!-- Loading indicator -->
    <div class="loading-indicator" aria-label="Loading, please wait..."></div>
    
    <!-- Three.js and other libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/postprocessing/6.23.4/postprocessing.min.js"></script>
    
    <!-- Project scripts -->
    <script src="js/script.js"></script>
    <script src="js/zen-elements.js"></script>
    <script src="js/enhanced-zen.js"></script>
    <script src="js/webgl-zen.js"></script>
    <script src="js/zen-audio.js"></script>
    <script src="js/zen-debug.js"></script>
    
    <!-- Initialize WebGL Zen Space with robust error handling -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Set a loading timeout to prevent getting stuck
        const LOADING_TIMEOUT = 8000; // 8 seconds
        let loadingTimer = setTimeout(function() {
          console.warn('Loading timeout reached - falling back to standard background');
          handleLoadingFailure('Loading timeout');
        }, LOADING_TIMEOUT);
        
        // Elements
        const cosmicBackground = document.querySelector('.cosmic-background');
        const bookContainer = document.querySelector('.book-container');
        const loadingScreen = document.getElementById('zen-loading');
        const audioControls = document.getElementById('zen-audio-controls');
        const balanceIndicator = document.getElementById('balance-indicator');
        const zenSpaceContainer = document.getElementById('zen-space-container');
        
        // Check WebGL compatibility
        function isWebGLAvailable() {
          try {
            const canvas = document.createElement('canvas');
            return !!(window.WebGLRenderingContext && 
              (canvas.getContext('webgl') || canvas.getContext('experimental-webgl')));
          } catch (e) {
            console.error('WebGL check error:', e);
            return false;
          }
        }
        
        // Handle loading failure
        function handleLoadingFailure(reason) {
          console.warn('Zen Space loading failed:', reason);
          
          // Clear timeout if it exists
          if (loadingTimer) {
            clearTimeout(loadingTimer);
            loadingTimer = null;
          }
          
          // Hide loading screen
          if (loadingScreen) {
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
              loadingScreen.style.display = 'none';
            }, 500);
          }
          
          // Show DOM background as fallback
          if (cosmicBackground) {
            cosmicBackground.style.display = 'block';
          }
          
          // Hide WebGL elements
          if (audioControls) audioControls.style.display = 'none';
          if (balanceIndicator) balanceIndicator.style.display = 'none';
          if (zenSpaceContainer) zenSpaceContainer.style.display = 'none';
          
          // Show book container
          if (bookContainer) {
            bookContainer.style.opacity = '1';
          }
        }
        
        // Handle loading success
        function handleLoadingSuccess() {
          console.log('Zen Space loaded successfully');
          
          // Clear timeout
          if (loadingTimer) {
            clearTimeout(loadingTimer);
            loadingTimer = null;
          }
          
          // Fade out loading screen
          if (loadingScreen) {
            setTimeout(() => {
              loadingScreen.style.opacity = '0';
              setTimeout(() => {
                loadingScreen.style.display = 'none';
                
                // Show book container with fade-in
                if (bookContainer) {
                  bookContainer.style.transition = 'opacity 1.5s ease-in-out';
                  bookContainer.style.opacity = '1';
                }
              }, 1000);
            }, 2000); // Give it a bit more time to finish any async initializations
          }
        }
        
        // Initialize app
        function initApp() {
          // Add zen font if not already loaded
          if (!document.querySelector('link[href*="Zen+Old+Mincho"]')) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://fonts.googleapis.com/css2?family=Zen+Old+Mincho&display=swap';
            document.head.appendChild(link);
          }
          
          // Hide DOM background
          if (cosmicBackground) {
            cosmicBackground.style.display = 'none';
          }
          
          // Prepare book container for transition
          if (bookContainer) {
            bookContainer.style.opacity = '0';
            bookContainer.style.transition = 'opacity 1.5s ease-in-out';
          }
          
          // Check requirements
          if (!window.THREE) {
            return handleLoadingFailure('Three.js not loaded');
          }
          
          if (!window.ZenSpace) {
            return handleLoadingFailure('ZenSpace object not defined');
          }
          
          if (!isWebGLAvailable()) {
            return handleLoadingFailure('WebGL not supported');
          }
          
          // Try initializing ZenSpace with error handling
          try {
            // Add chakra data
            const chakraData = [
              {
                name: 'Root Chakra (Muladhara)',
                color: '#ff0000',
                description: 'Foundation and stability. Connects us to Earth and grounds our being.'
              },
              {
                name: 'Sacral Chakra (Svadhisthana)',
                color: '#ff7f00',
                description: 'Creativity and emotion. Center of pleasure, joy, and our connection to others.'
              },
              {
                name: 'Solar Plexus Chakra (Manipura)',
                color: '#ffff00',
                description: 'Personal power and will. Source of self-esteem, warrior energy, and autonomy.'
              },
              {
                name: 'Heart Chakra (Anahata)',
                color: '#00ff00',
                description: 'Love and compassion. Bridge between lower and higher chakras, connecting mind and body.'
              },
              {
                name: 'Throat Chakra (Vishuddha)',
                color: '#0000ff',
                description: 'Communication and expression. Enables us to speak our truth with clarity and confidence.'
              },
              {
                name: 'Third Eye Chakra (Ajna)',
                color: '#4b0082',
                description: 'Intuition and wisdom. Center of insight, imagination and our ability to see beyond illusion.'
              },
              {
                name: 'Crown Chakra (Sahasrara)',
                color: '#9400d3',
                description: 'Spirituality and consciousness. Connection to higher states of being and divine wisdom.'
              }
            ];
            window.ZenSpace.chakraData = chakraData;
            
            // Initialize ZenSpace
            const initResult = window.ZenSpace.init('zen-space-container');
            if (!initResult) {
              return handleLoadingFailure('ZenSpace initialization returned false');
            }
            
            // Setup audio controls
            if (audioControls) {
              const audioOn = document.getElementById('audio-on');
              const audioOff = document.getElementById('audio-off');
              
              audioControls.addEventListener('click', function() {
                if (window.ZenSpace.audio.enabled) {
                  // Disable audio
                  window.ZenSpace.audio.enabled = false;
                  audioOn.style.display = 'none';
                  audioOff.style.display = 'block';
                } else {
                  // Enable audio
                  window.ZenSpace.audio.enabled = true;
                  audioOn.style.display = 'block';
                  audioOff.style.display = 'none';
                  
                  // Initialize audio if not already done
                  if (!window.ZenSpace.audio.initialized && window.ZenSpace.initAudio) {
                    window.ZenSpace.initAudio();
                  }
                }
              });
            }
            
            // Mark as successful
            handleLoadingSuccess();
            
          } catch (error) {
            console.error('Error initializing ZenSpace:', error);
            return handleLoadingFailure(error.message || 'Unknown error');
          }
        }
        
        // Start initialization
        initApp();
      });
    </script>
</body>
</html>
